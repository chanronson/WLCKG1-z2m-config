<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>WLCKG1 Log Parser</title>
    <style>
        /* ---------- THEME ---------- */

        :root {
            --bg: #121212;
            --fg: #e0e0e0;
            --card: #1e1e1e;
            --border: #2a2a2a;
            --accent: #4ea1ff;
            --warning: #faa05b;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg: #f5f5f5;
                --fg: #1a1a1a;
                --card: #ffffff;
                --border: #d0d0d0;
                --accent: #0066cc;
            }
        }

        body:has(#themeToggle:checked) {
            --bg: #f5f5f5;
            --fg: #1a1a1a;
            --card: #ffffff;
            --border: #d0d0d0;
            --accent: #0066cc;
        }

        body {
            background: var(--bg);
            color: var(--fg);
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 16px;
        }

        /* ---------- LAYOUT ---------- */

        .container {
            max-width: 900px;
            margin: auto;
        }

        .card {
            background: var(--card);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .card.static {
            padding: 16px;
        }

        summary {
            cursor: pointer;
            list-style: none;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary h2 {
            display: inline;
        }

        details[open] summary {
            margin-bottom: 12px;
        }

        /* ---------- ACCESSIBILITY ---------- */

        a {
            color: var(--accent);
        }

        :focus-visible {
            outline: 3px solid var(--accent);
            outline-offset: 3px;
        }

        button,
        input,
        select {
            font-size: 1rem;
        }

        /* ---------- FORMS ---------- */

        .form-group {
            margin-bottom: 16px;
        }

        .primary-button {
            padding: 8px 16px;
            cursor: pointer;
        }

        .warning {
            color: var(--warning);
            margin-bottom: 8px;
        }

        /* ---------- TABLE ---------- */

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            min-width: 600px;
        }

        th,
        td {
            border: 1px solid var(--border);
            padding: 8px;
            text-align: left;
        }

        th {
            background: rgba(0, 0, 0, 0.1);
        }

        thead th {
            position: sticky;
            top: 0;
            background: var(--card);
            z-index: 1;
        }

        tbody tr:has(select:not([value=""])) {
            background-color: rgba(78, 161, 255, 0.08);
        }

        tbody tr:hover {
            background-color: rgba(78, 161, 255, 0.15);
        }

        /* ---------- MOBILE ---------- */

        @media (max-width: 600px) {
            body {
                padding: 8px;
            }

            h1 {
                font-size: 1.1rem;
            }

            h2 {
                font-size: 1rem;
            }

            .primary-button {
                width: 100%;
            }
        }

        @media (max-width: 600px) {
            table {
                font-size: 0.85rem;
            }

            select {
                width: 100%;
            }

            td {
                vertical-align: top;
            }
        }


        /* ---------- THEME TOGGLE ---------- */

        .theme-toggle {
            position: fixed;
            top: 12px;
            right: 12px;
            width: 20px;
            height: 20px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chevron {
            width: 10px;
            height: 10px;
            border-right: 2px solid currentColor;
            border-bottom: 2px solid currentColor;
            transform: rotate(-45deg);
            transition: transform 0.2s ease;
        }

        details[open] .chevron {
            transform: rotate(45deg);
        }

        select {
            background: var(--card);
            color: var(--fg);
            border: 1px solid var(--border);
            padding: 4px 6px;
            border-radius: 4px;
        }

        select:disabled {
            opacity: 0.4;
        }

        /* theme switch */
        .theme-switch {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 16px;
        }

        .theme-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .theme-text {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .theme-toggle {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        /* Switch track */
        .theme-slider {
            width: 36px;
            height: 20px;
            background: var(--border);
            border-radius: 999px;
            position: relative;
            transition: background 0.2s ease;
        }

        /* Switch thumb */
        .theme-slider::after {
            content: "";
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: var(--fg);
            border-radius: 50%;
            transition: transform 0.2s ease;
        }

        /* Checked state */
        .theme-toggle:checked+.theme-slider {
            background: var(--accent);
        }

        .theme-toggle:checked+.theme-slider::after {
            transform: translateX(16px);
        }

        /* Keyboard focus */
        .theme-toggle:focus-visible+.theme-slider {
            outline: 3px solid var(--accent);
            outline-offset: 3px;
        }
    </style>
</head>

<body>
    <main class="container" aria-labelledby="page-title">
        <div class="theme-switch">
            <label for="themeToggle" class="theme-label">
                <span class="theme-text">Light Theme</span>
                <input type="checkbox" id="themeToggle" class="theme-toggle" aria-label="Toggle light or dark theme">
                <span class="theme-slider" aria-hidden="true"></span>
            </label>
        </div>
        <header class="card static">
            <h1 id="page-title">WLCKG1 Raw Log Analyzer for zigbee2mqtt (Z2M)</h1>
        </header>

        <details class="card" open>
            <summary class="card-header">
                <span class="chevron" aria-hidden="true"></span>
                <h2 id="instructions-title">Instructions</h2>
            </summary>

            <div class="step">
                <p>Add this file:</p>
                <p>
                    right click and save to:
                    <a href="zigbee2mqtt/external_converters/wyze-lock-ext.js" download="wyze-lock-ext.js"
                        aria-label="Download wyze-lock-ext.js">
                        zigbee2mqtt/external_converters/wyze-lock-ext.js

                    </a>
                </p>
            </div>

            <div class="step">
                <p>Add the following to the bottom of your <code>config.yaml</code>:</p>
                <pre aria-label="config.yaml example">
external_converters:
  - wyze-lock-ext.js
        </pre>
            </div>

            <ol class="instructions-list">
                <li>Restart the server</li>
                <li>Open the logs in Z2M</li>
                <li>Set <code>Show only</code> to <code>debug</code></li>
                <li>In <code>Filter by text</code> type <code>raw</code></li>
                <li>Set <code>Logs limit</code> to <code>1000</code></li>
                <li>Set <code>Log level config</code> to <code>debug</code></li>
                <li>Clear the logs</li>
                <li>Record/remember action order (app lock/unlock →locked → unlock → open → close → lock → auto-lock)
                </li>
                <li>Pause for a few seconds between actions</li>
                <li>Copy all the logs; paste below</li>
            </ol>
        </details>

        <details class="card" open>
            <summary class="card-header">
                <span class="chevron" aria-hidden="true"></span>
                <h2 id="upload-title">Log Text</h2>
            </summary>

            <div class="form-group">
                <label for="logs">Paste Logs here:</label>
                <br>
                <textarea id="logs"></textarea>
            </div>
        </details>

        <section class="results-section">
            <div id="warning" class="warning" role="alert" aria-live="polite" hidden></div>
            <pre id="output"></pre>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Data Length</th>
                            <th>Event Source</th>
                            <th>Event State</th>
                        </tr>
                    </thead>
                    <tbody id="results"></tbody>
                </table>
            </div>
        </section>
        <br>
        <section>
            <details class="card" open>
            <summary class="card-header">
                <span class="chevron" aria-hidden="true"></span>
                <h2 id="code-title">Code and issues</h2>
            </summary>
            <a href="https://github.com/JamesOsborn-SE/WLCKG1-z2m-config"> GitHub</a>
        </details>

        </section>
    </main>

    <script>
        const SOURCE_OPTIONS = ["Door", "Manual", "Auto", "App", "Lock"];
        const STATE_OPTIONS = ["Open", "Closed", "Locked", "Unlocked"];
        function onStateChange(select) {
            const stateRaw = select.dataset.raw;
            const newState = select.value;

            document
                .querySelectorAll(`select[data-type="state"][data-raw="${stateRaw}"]`)
                .forEach(s => {
                    s.value = newState;
                });
        }
        function onSourceChange(select) {
            const sourceRaw = select.dataset.raw;
            const newSource = select.value;

            document
                .querySelectorAll(`select[data-type="source"][data-raw="${sourceRaw}"]`)
                .forEach(s => {
                    s.value = newSource;
                    const row = s.closest("tr");
                    validateRowState(row);
                });
        }
        function validateRowState(row) {
            const sourceSelect = row.querySelector('select[data-type="source"]');
            const stateSelect = row.querySelector('select[data-type="state"]');

            if (!sourceSelect || !stateSelect) return;

            const source = sourceSelect.value;

            const allowedStates =
                source === "Door"
                    ? ["Open", "Closed"]
                    : ["Locked", "Unlocked"];

            [...stateSelect.options].forEach(opt => {
                if (opt.value === "") return;
                opt.disabled = !allowedStates.includes(opt.value);
            });

            if (stateSelect.value && !allowedStates.includes(stateSelect.value)) {
                stateSelect.value = "--";
            }
        }
        function createSelect(options, type, rawValue) {
            const select = document.createElement("select");
            select.dataset.type = type;
            select.dataset.raw = rawValue;

            const empty = document.createElement("option");
            empty.value = "";
            empty.textContent = "--";
            select.appendChild(empty);

            options.forEach(opt => {
                const o = document.createElement("option");
                o.value = opt;
                o.textContent = opt;
                select.appendChild(o);
            });

            select.addEventListener("change", () => {
                if (type === "source") {
                    onSourceChange(select);
                } else {
                    onStateChange(select);
                }
                updateOutput();
            });

            return select;
        }
        logText = document.getElementById("logs")
        logText.addEventListener("change", function (event) {
            const text = logText.value;
            const lines = text.split(/\r?\n/);
            const tbody = document.getElementById("results");
            tbody.innerHTML = "";

            for (const line of lines) {
                if (!line.includes("Lock")) continue;
                if (!line.includes("type 'raw'")) continue;
                if (!line.includes('"data":')) continue;

                const tsMatch = line.match(/^\[(.*?)\]/);
                if (!tsMatch) continue;

                const jsonMatch = line.match(/'(\{.*?"type":"Buffer"\})'/);
                if (!jsonMatch) continue;

                let parsed;
                try {
                    parsed = JSON.parse(jsonMatch[1]);
                } catch {
                    continue;
                }

                if (!Array.isArray(parsed.data)) continue;

                const len = parsed.data.length;
                if (len <= 70 || len >= 90) continue;

                const eventSource = parsed.data[57];
                const eventState = parsed.data[46];

                const row = document.createElement("tr");

                row.innerHTML = `
            <td>${tsMatch[1]}</td>
            <td>${len}</td>
        `;

                const sourceCell = document.createElement("td");
                sourceCell.appendChild(createSelect(SOURCE_OPTIONS, "source", eventSource));

                const stateCell = document.createElement("td");
                stateCell.appendChild(createSelect(STATE_OPTIONS, "state", eventState));

                row.appendChild(sourceCell);
                row.appendChild(stateCell);
                tbody.appendChild(row);
            }
        });

        function updateOutput() {
            const mappings = {
                "Source Door": null,
                "Source Manual": null,
                "Source Auto": null,
                "Source App": null,
                "Door Open": null,
                "Door Closed": null,
                "Lock Locked": null,
                "Lock Unlocked": null
            };

            document.querySelectorAll("select").forEach(select => {
                if (!select.value) return;

                const raw = select.dataset.raw;
                const label =
                    select.dataset.type === "source"
                        ? `Source ${select.value}`
                        : `${select.value.includes("Open") || select.value.includes("Closed") ? "Door" : "Lock"} ${select.value}`;

                if (mappings[label] === null) {
                    mappings[label] = raw;
                }
            });

            const missing = Object.entries(mappings)
                .filter(([, v]) => v === null)
                .map(([k]) => k);

            const warning = document.getElementById("warning");
            warning.style.display = missing.length ? "block" : "none";
            warning.textContent = missing.length
                ? "Warning: missing values — " + missing.join(", ")
                : "";

            const output = Object.entries(mappings)
                .map(([k, v]) => `${k}: ${v}`)
                .join("\n");

            document.getElementById("output").textContent = output;
        };
        updateOutput();
    </script>

</body>

</html>